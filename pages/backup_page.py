#!/usr/bin/env python3
"""
Updated Backup Management Dashboard Page
Support for both Drive-backed and CSV storage systems
"""

import streamlit as st
import pandas as pd
from datetime import datetime, date, timedelta
from pathlib import Path
import json
import sys
import os

# Add parent directory to path for imports
sys.path.append(os.path.dirname(os.path.dirname(__file__)))
from utils.auth_helper import is_admin_authenticated, show_admin_status

# Import new backup system
try:
    from integrations.auto_backup_personal import get_auto_backup_manager, manual_backup
    AUTO_BACKUP_AVAILABLE = True
except ImportError:
    AUTO_BACKUP_AVAILABLE = False

def show_backup_status_cards():
    """Display backup status cards using PersonalAutoBackupManager"""
    if not AUTO_BACKUP_AVAILABLE:
        st.error("üö´ Auto backup system not available")
        return
    
    # Get fund manager from session state
    if 'fund_manager' not in st.session_state:
        st.error("‚ùå Fund manager not initialized")
        return
    
    fund_manager = st.session_state.fund_manager
    backup_manager = get_auto_backup_manager(fund_manager)
    status = backup_manager.get_backup_status()
    
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        st.metric(
            label="üè† Service Status",
            value="Running" if status['service_running'] else "Stopped",
            delta="Active" if status['service_running'] else "Inactive"
        )
    
    with col2:
        st.metric(
            label="üíæ Local Backups",
            value=status['local_backups']['count'],
            delta=f"{status['local_backups']['total_size_mb']:.1f} MB"
        )
    
    with col3:
        cloud_count = status['cloud_backup'].get('files', 0) if status['cloud_backup']['connected'] else 0
        st.metric(
            label="‚òÅÔ∏è Cloud Backups", 
            value=cloud_count,
            delta="Connected" if status['cloud_backup']['connected'] else "Not connected"
        )
    
    with col4:
        st.metric(
            label="üìä Today's Backups",
            value=f"{status['backups_today']}/5",
            delta="Daily limit"
        )

def handle_restore_from_backup(backup_file_path, filename):
    """Handle restore operation from backup Excel file"""
    try:
        if 'fund_manager' not in st.session_state:
            st.error("‚ùå Fund manager not initialized")
            return
        
        # Confirmation dialog with backup info
        st.warning(f"‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën restore t·ª´ backup: **{filename}**?")
        st.warning("üî¥ **CH√ö √ù**: Thao t√°c n√†y s·∫Ω ghi ƒë√® to√†n b·ªô d·ªØ li·ªáu hi·ªán t·∫°i!")
        
        # Show preview of backup content
        try:
            import pandas as pd
            excel_data = pd.read_excel(backup_file_path, sheet_name=None)
            
            st.info("üìã **N·ªôi dung backup s·∫Ω ƒë∆∞·ª£c restore:**")
            backup_info = []
            for sheet_name, sheet_data in excel_data.items():
                if sheet_name in ['Investors', 'Tranches', 'Transactions', 'Fee_Records']:
                    backup_info.append(f"- **{sheet_name}**: {len(sheet_data)} records")
            
            if backup_info:
                for info in backup_info:
                    st.markdown(info)
        except Exception as e:
            st.warning(f"‚ö†Ô∏è Kh√¥ng th·ªÉ preview backup: {str(e)}")
        
        col1, col2, col3 = st.columns([1, 1, 2])
        
        with col1:
            if st.button("‚úÖ X√°c nh·∫≠n Restore", key="confirm_restore", type="primary"):
                with st.spinner(f"üîÑ ƒêang restore t·ª´ {filename}..."):
                    # Create safety backup first
                    try:
                        safety_backup_success = False
                        if AUTO_BACKUP_AVAILABLE:
                            from integrations.auto_backup_personal import manual_backup
                            safety_backup_success = manual_backup(st.session_state.fund_manager, "pre_restore_safety")
                            if safety_backup_success:
                                st.info("‚úÖ ƒê√£ t·∫°o safety backup tr∆∞·ªõc khi restore")
                    except:
                        pass  # Continue even if safety backup fails
                    # Read Excel backup file
                    import pandas as pd
                    
                    # Read all sheets from backup
                    excel_data = pd.read_excel(backup_file_path, sheet_name=None)
                    
                    success_count = 0
                    errors = []
                    
                    # Restore investors
                    if 'Investors' in excel_data:
                        try:
                            investors_df = excel_data['Investors']
                            # Convert back to CSV format and save
                            investors_df.to_csv('data/investors.csv', index=False)
                            success_count += 1
                        except Exception as e:
                            errors.append(f"Investors: {str(e)}")
                    
                    # Restore tranches  
                    if 'Tranches' in excel_data:
                        try:
                            tranches_df = excel_data['Tranches']
                            tranches_df.to_csv('data/tranches.csv', index=False)
                            success_count += 1
                        except Exception as e:
                            errors.append(f"Tranches: {str(e)}")
                    
                    # Restore transactions
                    if 'Transactions' in excel_data:
                        try:
                            transactions_df = excel_data['Transactions']
                            transactions_df.to_csv('data/transactions.csv', index=False)
                            success_count += 1
                        except Exception as e:
                            errors.append(f"Transactions: {str(e)}")
                    
                    # Restore fee records
                    if 'Fee_Records' in excel_data:
                        try:
                            fees_df = excel_data['Fee_Records']
                            fees_df.to_csv('data/fee_records.csv', index=False)
                            success_count += 1
                        except Exception as e:
                            errors.append(f"Fee Records: {str(e)}")
                    
                    # Reload fund manager data
                    st.session_state.fund_manager.load_data()
                    
                    # Show results
                    if success_count > 0:
                        st.success(f"‚úÖ Restore th√†nh c√¥ng {success_count} b·∫£ng d·ªØ li·ªáu!")
                        st.balloons()
                        if errors:
                            st.warning(f"‚ö†Ô∏è C√≥ {len(errors)} l·ªói:")
                            for error in errors:
                                st.error(f"  - {error}")
                        
                        # Auto-refresh after 2 seconds
                        import time
                        time.sleep(2)
                        st.rerun()
                    else:
                        st.error("‚ùå Kh√¥ng th·ªÉ restore d·ªØ li·ªáu")
                        for error in errors:
                            st.error(f"  - {error}")
        
        with col2:
            if st.button("‚ùå H·ªßy b·ªè", key="cancel_restore"):
                st.rerun()
                
    except Exception as e:
        st.error(f"‚ùå L·ªói restore: {str(e)}")

def show_backup_history():
    """Show backup history from local exports folder with restore functionality"""
    st.subheader("üìä Backup History")
    
    # Warning about restore
    with st.expander("‚ö†Ô∏è H∆∞·ªõng d·∫´n Restore"):
        st.warning("üî¥ **CH√ö √ù quan tr·ªçng v·ªÅ Restore:**")
        st.markdown("""
        - **Restore s·∫Ω ghi ƒë√® to√†n b·ªô d·ªØ li·ªáu hi·ªán t·∫°i**
        - N√™n t·∫°o backup hi·ªán t·∫°i tr∆∞·ªõc khi restore
        - Restore ch·ªâ √°p d·ª•ng cho file Excel backup
        - Sau restore, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông reload data
        """)
    
    export_dir = Path("exports")
    if not export_dir.exists():
        st.info("üìÅ No backup directory found")
        return
    
    # Get all backup files
    backup_files = list(export_dir.glob("Fund_Export_*.xlsx"))
    
    if not backup_files:
        st.info("üìÅ No backup files found")
        return
    
    # Create backup history data
    backup_data = []
    for file_path in backup_files:
        try:
            stats = file_path.stat()
            backup_data.append({
                'Filename': file_path.name,
                'Date': datetime.fromtimestamp(stats.st_mtime),
                'Size (KB)': round(stats.st_size / 1024, 1),
                'Type': 'Auto' if 'auto_' in file_path.name else 'Manual',
                'Path': str(file_path)
            })
        except Exception as e:
            st.warning(f"‚ö†Ô∏è Could not read {file_path.name}: {e}")
    
    if not backup_data:
        st.info("üìÅ No readable backup files found")
        return
    
    # Sort by date (newest first)
    backup_data.sort(key=lambda x: x['Date'], reverse=True)
    
    # Show as dataframe
    df = pd.DataFrame(backup_data)
    df['Date'] = df['Date'].dt.strftime('%Y-%m-%d %H:%M:%S')
    
    # Display table with restore buttons
    display_df = df.drop('Path', axis=1).copy()
    
    # Add restore column with better formatting
    st.markdown("**Danh s√°ch Backup Files (nh·∫•n üîÑ ƒë·ªÉ restore):**")
    
    for i, row in enumerate(backup_data):
        with st.container():
            col1, col2 = st.columns([5, 1])
            with col1:
                # Format the display with better styling
                file_date = row['Date'].strftime('%Y-%m-%d %H:%M')
                file_size_mb = row['Size (KB)'] / 1024
                type_emoji = "ü§ñ" if row['Type'] == 'Auto' else "üë§"
                
                st.markdown(f"""
                **{row['Filename']}**  
                üìÖ {file_date} | üì¶ {file_size_mb:.1f} MB | {type_emoji} {row['Type']}
                """)
            with col2:
                if st.button(f"üîÑ", key=f"restore_{i}", help=f"Restore t·ª´ backup: {row['Filename']}", type="secondary"):
                    handle_restore_from_backup(row['Path'], row['Filename'])
            
            st.divider()
    
    # Show total stats
    col1, col2, col3 = st.columns(3)
    with col1:
        st.metric("Total Files", len(backup_data))
    with col2:
        total_size = sum(item['Size (KB)'] for item in backup_data)
        st.metric("Total Size", f"{total_size/1024:.1f} MB")
    with col3:
        if backup_data:
            # Use original datetime objects from backup_data, not the string-converted ones
            latest = max(backup_data, key=lambda x: x['Date'])
            st.metric("Latest Backup", latest['Date'].strftime('%Y-%m-%d'))

def show_cloud_backup_status():
    """Show cloud backup status and details"""
    st.subheader("‚òÅÔ∏è Cloud Backup Status")
    
    if not AUTO_BACKUP_AVAILABLE:
        st.error("üö´ Auto backup system not available")
        return
    
    if 'fund_manager' not in st.session_state:
        st.error("‚ùå Fund manager not initialized")
        return
    
    fund_manager = st.session_state.fund_manager
    backup_manager = get_auto_backup_manager(fund_manager)
    status = backup_manager.get_backup_status()
    
    cloud_info = status['cloud_backup']
    
    if cloud_info['connected']:
        st.success("‚úÖ Cloud backup connected")
        
        col1, col2 = st.columns(2)
        with col1:
            st.info(f"üë§ Account: {cloud_info.get('account', 'Unknown')}")
            st.info(f"üîê Method: {cloud_info.get('method', 'Unknown')}")
        
        with col2:
            st.info(f"üìÑ Files in Drive: {cloud_info.get('files', 0)}")
            st.info("üìÅ Storage: 15GB free (personal account)")
        
        # Test connection button
        if st.button("üß™ Test Connection", help="Test Google Drive connection"):
            try:
                drive_manager = backup_manager.drive_manager
                if drive_manager:
                    test_result = drive_manager.test_connection()
                    if test_result.get('connected'):
                        st.success(f"‚úÖ Connection successful! Files: {test_result.get('files_count', 0)}")
                    else:
                        st.error("‚ùå Connection test failed")
                        for error in test_result.get('errors', []):
                            st.error(f"   - {error}")
                else:
                    st.warning("‚ö†Ô∏è Drive manager not available")
            except Exception as e:
                st.error(f"‚ùå Test failed: {e}")
    else:
        st.warning("‚ö†Ô∏è Cloud backup not connected")
        if 'error' in cloud_info:
            st.error(f"Error: {cloud_info['error']}")
        
        st.info("üí° To enable cloud backup:")
        st.markdown("""
        1. Follow setup in `SETUP_OAUTH_PERSONAL.md`
        2. Create OAuth credentials
        3. Restart the app
        """)

def show_backup_controls():
    """Show backup control buttons and settings"""
    st.subheader("üéÆ Backup Controls")
    
    if not AUTO_BACKUP_AVAILABLE:
        st.error("üö´ Auto backup system not available")
        return
    
    if 'fund_manager' not in st.session_state:
        st.error("‚ùå Fund manager not initialized")
        return
    
    fund_manager = st.session_state.fund_manager
    backup_manager = get_auto_backup_manager(fund_manager)
    
    col1, col2, col3 = st.columns(3)
    
    with col1:
        if st.button("üìä Create Backup Now", type="primary", help="Create manual backup"):
            with st.spinner("Creating backup..."):
                success = manual_backup(fund_manager, "dashboard_manual")
            
            if success:
                st.success("‚úÖ Backup created successfully!")
                st.balloons()
                st.rerun()
            else:
                st.error("‚ùå Backup creation failed")
    
    with col2:
        if st.button("üîÑ Refresh Status", help="Refresh backup status"):
            st.rerun()
    
    with col3:
        if st.button("üßπ Clean Old Backups", help="Remove old local backups (keep 10 newest)"):
            try:
                export_dir = Path("exports")
                if export_dir.exists():
                    backup_files = list(export_dir.glob("Fund_Export_*.xlsx"))
                    backup_files.sort(key=lambda x: x.stat().st_mtime, reverse=True)
                    
                    if len(backup_files) > 10:
                        files_to_delete = backup_files[10:]
                        deleted_count = 0
                        
                        for file_path in files_to_delete:
                            try:
                                file_path.unlink()
                                deleted_count += 1
                            except Exception as e:
                                st.warning(f"Could not delete {file_path.name}: {e}")
                        
                        st.success(f"üßπ Cleaned up {deleted_count} old backup files")
                        st.rerun()
                    else:
                        st.info("‚úÖ No cleanup needed (‚â§10 files)")
                else:
                    st.warning("üìÅ No backup directory found")
                    
            except Exception as e:
                st.error(f"‚ùå Cleanup failed: {e}")

def show_backup_settings():
    """Show backup system settings"""
    st.subheader("‚öôÔ∏è Backup Settings")
    
    if not AUTO_BACKUP_AVAILABLE:
        st.error("üö´ Auto backup system not available")
        return
    
    if 'fund_manager' not in st.session_state:
        st.error("‚ùå Fund manager not initialized")
        return
    
    fund_manager = st.session_state.fund_manager
    backup_manager = get_auto_backup_manager(fund_manager)
    
    # Show current configuration
    st.json({
        "Local Backup": "Always enabled",
        "Cloud Backup": "OAuth-based (personal account)",
        "Daily Schedule": "23:00 (11 PM)",
        "Max Daily Backups": "5 backups",
        "Backup Interval": "6 hours minimum",
        "Local Retention": "20 newest files",
        "Storage Cost": "$0/month (personal Google Drive)"
    })
    
    # Show backup statistics
    status = backup_manager.get_backup_status()
    
    st.subheader("üìä Statistics")
    stats_data = {
        "Total Backups Created": status['stats']['total_backups'],
        "Successful Local": status['stats']['successful_local'],
        "Successful Cloud": status['stats']['successful_cloud'],
        "Failed Backups": status['stats']['failed_backups'],
        "Service Uptime": "Running" if status['service_running'] else "Stopped"
    }
    
    if status['stats']['last_error']:
        stats_data["Last Error"] = status['stats']['last_error']

    st.json(stats_data)

def show_drive_backup_controls():
    """Show manual backup controls for Drive-backed storage"""
    st.subheader("‚òÅÔ∏è Google Drive Backup Controls")

    # Check if using Drive handler
    if 'fund_manager' not in st.session_state:
        st.info("‚ÑπÔ∏è Fund manager ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o")
        return

    fund_manager = st.session_state.fund_manager
    data_handler = fund_manager.data_handler

    # Check if it's Drive handler
    is_drive_handler = type(data_handler).__name__ == 'DriveBackedDataManager'

    if not is_drive_handler:
        st.info("‚ÑπÔ∏è ƒêang s·ª≠ d·ª•ng CSV local storage - kh√¥ng c·∫ßn Drive backup")
        return

    # Show Drive connection status
    col1, col2, col3 = st.columns(3)

    with col1:
        if data_handler.connected:
            st.success("‚úÖ Google Drive ƒë√£ k·∫øt n·ªëi")
        else:
            st.error("‚ùå Google Drive ch∆∞a k·∫øt n·ªëi")

    with col2:
        if f'{data_handler.session_key_prefix}last_backup' in st.session_state:
            last_backup = st.session_state[f'{data_handler.session_key_prefix}last_backup']
            time_ago = datetime.now() - last_backup
            minutes_ago = int(time_ago.total_seconds() / 60)
            st.metric("Backup cu·ªëi", f"{minutes_ago} ph√∫t tr∆∞·ªõc")
        else:
            st.metric("Backup cu·ªëi", "Ch∆∞a c√≥")

    with col3:
        if f'{data_handler.session_key_prefix}last_load' in st.session_state:
            last_load = st.session_state[f'{data_handler.session_key_prefix}last_load']
            time_ago = datetime.now() - last_load
            minutes_ago = int(time_ago.total_seconds() / 60)
            st.metric("Load cu·ªëi", f"{minutes_ago} ph√∫t tr∆∞·ªõc")
        else:
            st.metric("Load cu·ªëi", "Ch∆∞a c√≥")

    st.divider()

    # Manual backup button
    col1, col2, col3 = st.columns([1, 1, 2])

    with col1:
        if st.button("üíæ Backup Ngay", type="primary", key="manual_drive_backup", use_container_width=True):
            if data_handler.connected:
                success = data_handler.backup_to_drive()
                if success:
                    st.success("‚úÖ Backup th√†nh c√¥ng!")
                    st.balloons()
                else:
                    st.error("‚ùå Backup th·∫•t b·∫°i")
            else:
                st.error("‚ùå Google Drive ch∆∞a k·∫øt n·ªëi")

    with col2:
        if st.button("üîÑ Reload t·ª´ Drive", key="reload_from_drive", use_container_width=True):
            if data_handler.connected:
                with st.spinner("üì• ƒêang t·∫£i d·ªØ li·ªáu t·ª´ Drive..."):
                    success = data_handler.load_from_drive()
                    if success:
                        # Reload fund manager
                        fund_manager.load_data()
                        st.success("‚úÖ ƒê√£ reload d·ªØ li·ªáu!")
                        st.rerun()
                    else:
                        st.error("‚ùå Reload th·∫•t b·∫°i")
            else:
                st.error("‚ùå Google Drive ch∆∞a k·∫øt n·ªëi")

def main():
    """Main backup dashboard function"""
    st.set_page_config(
        page_title="Backup Management",
        page_icon="üíæ",
        layout="wide"
    )
    
    st.title("üíæ Backup Management Dashboard")

    # Check authentication (but don't require it since auth is disabled)
    if is_admin_authenticated():
        show_admin_status()
    else:
        st.success("üè† Local System - Full Access Enabled")

    # Drive backup controls (for cloud deployment)
    show_drive_backup_controls()

    st.divider()

    # Main backup dashboard
    if AUTO_BACKUP_AVAILABLE:
        # Status cards
        show_backup_status_cards()

        st.divider()

        # Controls
        show_backup_controls()
        
        st.divider()
        
        # Two column layout for details
        col1, col2 = st.columns(2)
        
        with col1:
            show_backup_history()
        
        with col2:
            show_cloud_backup_status()
        
        st.divider()
        
        # Settings
        show_backup_settings()
        
    else:
        st.error("üö´ Auto backup system not available")
        st.info("üí° Make sure auto_backup_personal.py is properly installed")
        
        # Show debug info
        with st.expander("üîç Debug Information"):
            if 'fund_manager' in st.session_state:
                fm = st.session_state.fund_manager
                st.json({
                    "Fund Manager Type": type(fm).__name__,
                    "Has backup_manager": hasattr(fm, 'backup_manager'),
                    "backup_manager value": str(getattr(fm, 'backup_manager', None)) if hasattr(fm, 'backup_manager') else "N/A",
                    "Data Handler Type": type(fm.data_handler).__name__,
                    "Auto Backup Available": AUTO_BACKUP_AVAILABLE,
                    "Backup System": "PersonalAutoBackupManager (integrated via app.py)"
                })
            else:
                st.warning("Fund manager not in session state")

if __name__ == "__main__":
    main()